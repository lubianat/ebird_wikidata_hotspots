var mymap = L.map('mapid').setView([{{ lat }}, {{ lng }}], 13);

var blueIcon = L.divIcon({
className: 'custom-div-icon',
html: "<svg xmlns='http://www.w3.org/2000/svg' width='30' height='30'><circle cx='15' cy='15' r='10' stroke='black' stroke-width='2' fill='blue' /></svg>",
iconSize: [30, 30],
iconAnchor: [15, 15]
});

var redIcon = L.divIcon({
className: 'custom-div-icon',
html: "<svg xmlns='http://www.w3.org/2000/svg' width='30' height='30'><circle cx='15' cy='15' r='10' stroke='black' stroke-width='2' fill='red' /></svg>",
iconSize: [30, 30],
iconAnchor: [15, 15]
});

function convertImageUrl(originalUrl) {
  var filename = originalUrl.split("/").pop();
  filename = filename.replace("%20", "_");  // replace spaces with underscores
  
  // Split filename into parts for constructing the URL
  var firstLetter = filename[0];
  var secondLetter = filename[1];
  
  var newUrl = "https://upload.wikimedia.org/wikipedia/commons/thumb/" 
               + firstLetter + "/" + firstLetter + secondLetter + "/" 
               + filename + "/320px-" + filename;

  return newUrl;
}

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
    maxZoom: 18
}).addTo(mymap);

var data = {{ data|tojson }};

for (var i = 0; i < data.length; i++) {
    var icon = data[i].wikidata ? blueIcon : redIcon;
    var marker = L.marker([data[i].lat, data[i].lng], { icon: icon }).addTo(mymap);

    var popupContent = "<b>" + data[i].locName + "</b><br>" + data[i].countryCode + "<br>All time species count: " + data[i].numSpeciesAllTime + "<br>locId: " + data[i].locId;

    if (data[i].wikidata) {
        popupContent += "<br><a href='" + data[i].wikidata + "' target='_blank'>View on Wikidata</a>";
    } else {
        var searchUrl = "https://www.wikidata.org/wiki/Special:Search?search=" + encodeURIComponent(data[i].locName);
        popupContent += "<br><a href='" + searchUrl + "' target='_blank'>Search on Wikidata</a>";
    }
    if (data[i].image) {
      var fileName = data[i].image.split("/").pop();
      var commonsLink = "https://commons.wikimedia.org/wiki/File:" + fileName;
      var imageSource = data[i].image
      popupContent += "<br><a href='" + commonsLink + "' target='_blank'><img src='" + imageSource + "' alt='Image' style='max-width: 100%; max-height: 200px;'></a>";
    }
    popupContent += "<br><a href=https://ebird.org/hotspot/" + data[i].locId + " target='_blank'>View on eBird</a>";

    marker.bindPopup(popupContent);
}
